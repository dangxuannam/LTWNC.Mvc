@model CheapDeal.WebApp.Areas.Adm.Controllers.FinancialReportViewModel

@{
    ViewBag.Title = "Báo cáo tài chính";
}

<div class="row">
    <div class="col-lg-12">
        <div class="ibox">
            <div class="ibox-title">
                <h5><i class="fa fa-bar-chart"></i> Báo cáo tài chính</h5>
                <div class="ibox-tools">
                    <button class="btn btn-primary btn-xs" onclick="exportReport()">
                        <i class="fa fa-file-pdf-o"></i> Export PDF
                    </button>
                </div>
            </div>
            <div class="ibox-content">
                @using (Html.BeginForm("Report", "Payment", FormMethod.Get, new { @class = "form-inline m-b-lg" }))
                {
                    <div class="form-group">
                        <label>Kỳ báo cáo:</label>
                        <select name="period" class="form-control" onchange="this.form.submit()">
                            <option value="month" @(Model.Period == "month" ? "selected" : "")>Theo tháng</option>
                            <option value="year" @(Model.Period == "year" ? "selected" : "")>Theo năm</option>
                        </select>
                    </div>

                    if (Model.Period == "month")
                    {
                        <div class="form-group">
                            <label>Tháng:</label>
                            <select name="month" class="form-control" onchange="this.form.submit()">
                                @for (int i = 1; i <= 12; i++)
                                {
                                    <option value="@i" @(Model.Month == i ? "selected" : "")>Tháng @i</option>
                                }
                            </select>
                        </div>
                    }

                    <div class="form-group">
                        <label>Năm:</label>
                        <select name="year" class="form-control" onchange="this.form.submit()">
                            @for (int i = DateTime.Now.Year; i >= DateTime.Now.Year - 5; i--)
                            {
                                <option value="@i" @(Model.Year == i ? "selected" : "")>@i</option>
                            }
                        </select>
                    </div>
                }

                <div class="row m-t-lg">
                    <div class="col-lg-4">
                        <div class="widget style1 navy-bg">
                            <div class="row">
                                <div class="col-xs-4">
                                    <i class="fa fa-money fa-5x"></i>
                                </div>
                                <div class="col-xs-8 text-right">
                                    <span>Tổng doanh thu</span>
                                    <h2 class="font-bold">@Model.TotalRevenue.ToString("N0") đ</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="widget style1 lazur-bg">
                            <div class="row">
                                <div class="col-xs-4">
                                    <i class="fa fa-shopping-cart fa-5x"></i>
                                </div>
                                <div class="col-xs-8 text-right">
                                    <span>Tổng đơn hàng</span>
                                    <h2 class="font-bold">@Model.TotalOrders</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="widget style1 yellow-bg">
                            <div class="row">
                                <div class="col-xs-4">
                                    <i class="fa fa-calculator fa-5x"></i>
                                </div>
                                <div class="col-xs-8 text-right">
                                    <span>Giá trị TB/đơn</span>
                                    <h2 class="font-bold">@Model.AverageOrderValue.ToString("N0") đ</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row m-t-lg">
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>Doanh thu theo ngày</h5>
                            </div>
                            <div class="ibox-content">
                                <canvas id="revenueChart" height="140"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>Phương thức thanh toán</h5>
                            </div>
                            <div class="ibox-content">
                                <canvas id="paymentMethodChart" height="140"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row m-t-lg">
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>Thống kê theo phương thức</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Phương thức</th>
                                            <th>Số lượng</th>
                                            <th>Tổng tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.PaymentMethodStats != null)
                                        {
                                            foreach (var stat in Model.PaymentMethodStats)
                                            {
                                                <tr>
                                                    <td>
                                                        @if (stat.Method == "MoMo")
                                                        {
                                                            <span class="label label-primary">@stat.Method</span>
                                                        }
                                                        else if (stat.Method == "VNPay")
                                                        {
                                                            <span class="label label-info">@stat.Method</span>
                                                        }
                                                        else if (stat.Method == "COD")
                                                        {
                                                            <span class="label label-warning">@stat.Method</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="label label-default">@stat.Method</span>
                                                        }
                                                    </td>
                                                    <td>@stat.Count đơn</td>
                                                    <td class="text-navy">@stat.Amount.ToString("N0") đ</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>Top 10 khách hàng</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Khách hàng</th>
                                            <th>Đơn hàng</th>
                                            <th>Tổng tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.TopCustomers != null)
                                        {
                                            int index = 1;
                                            foreach (var customer in Model.TopCustomers)
                                            {
                                                <tr>
                                                    <td>@index</td>
                                                    <td>@customer.CustomerName</td>
                                                    <td>@customer.TotalOrders</td>
                                                    <td class="text-navy">@customer.TotalAmount.ToString("N0") đ</td>
                                                </tr>
                                                index++;
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row m-t-lg">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>Chi tiết doanh thu theo ngày</h5>
                            </div>
                            <div class="ibox-content">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ngày</th>
                                                <th>Số đơn hàng</th>
                                                <th>Doanh thu</th>
                                                <th>Giá trị TB</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (Model.DailyRevenue != null)
                                            {
                                                foreach (var day in Model.DailyRevenue)
                                                {
                                                    <tr>
                                                        <td>@day.Date.ToString("dd/MM/yyyy")</td>
                                                        <td>@day.OrderCount</td>
                                                        <td class="text-navy">@day.Revenue.ToString("N0") đ</td>
                                                        <td>@((day.OrderCount > 0 ? day.Revenue / day.OrderCount : 0).ToString("N0")) đ</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        $(document).ready(function() {
            var dailyLabels = [];
            var dailyRevenue = [];

            @if (Model.DailyRevenue != null)
            {
                foreach (var day in Model.DailyRevenue)
                {
                    @:dailyLabels.push('@day.Date.ToString("dd/MM")');
                    @:dailyRevenue.push(@day.Revenue);
                }
            }

            var paymentLabels = [];
            var paymentAmounts = [];

            @if (Model.PaymentMethodStats != null)
            {
                foreach (var stat in Model.PaymentMethodStats)
                {
                    @:paymentLabels.push('@stat.Method');
                    @:paymentAmounts.push(@stat.Amount);
                }
            }

            var revenueCtx = document.getElementById('revenueChart').getContext('2d');
            var revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: dailyRevenue,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    }
                }
            });

            var methodCtx = document.getElementById('paymentMethodChart').getContext('2d');
            var methodChart = new Chart(methodCtx, {
                type: 'doughnut',
                data: {
                    labels: paymentLabels,
                    datasets: [{
                        data: paymentAmounts,
                        backgroundColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 205, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    }
                }
            });
        });

        function exportReport() {
            var period = '@Model.Period';
            var year = @Model.Year;
            var month = @Model.Month;

            var form = $('<form>', {
                'method': 'POST',
                'action': '@Url.Action("ExportReport", "Payment")'
            });

            $('<input>').attr({ type: 'hidden', name: 'period', value: period }).appendTo(form);
            $('<input>').attr({ type: 'hidden', name: 'year', value: year }).appendTo(form);
            $('<input>').attr({ type: 'hidden', name: 'month', value: month }).appendTo(form);
            $('<input>').attr({
                type: 'hidden',
                name: '__RequestVerificationToken',
                value: $('input[name="__RequestVerificationToken"]').val()
            }).appendTo(form);

            form.appendTo('body').submit();
        }
    </script>

    <style>
        .widget {
            padding: 20px;
            border-radius: 5px;
            color: white;
        }

            .widget i {
                opacity: 0.7;
            }
    </style>
}
