@model PagedList.IPagedList<Supplier>
@{ ViewBag.Title = "Quản lý nhà cung cấp ";}

@section pluginsStyles {
    <link href="~/Content/PagedList.css" rel="stylesheet" />
    <link href="~/Content/AdmGrid.css" rel="stylesheet" />
}
<style>
    button.toggle {
        border: none;
        background: none;
        padding: 0;
        outline: none;
        font-size: 20px;
        cursor: pointer;
        width: 30px; 
        text-align: center;
        font-family: FontAwesome; 
    }
        button.toggle.true::before {
            content: "\f058"; 
            color: #1ab394; 
        }

        
        button.toggle.false::before {
            content: "\f057"; 
            color: #ed5565; 
        }

    #activedFilter {
        height: 34px !important;
        padding: 6px 12px !important;
        font-size: 14px !important;
        line-height: 1.42857143 !important;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 200px;
    }

    #activedFilter {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .info-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

        .info-list li {
            margin-bottom: 4px;
        }
        
</style>
<div class="row">
    <div class="col-md-12">
        <div class="ibox float-e-margins ">
            <div class="ibox-title">
                <h5>Danh sách nhà cung cấp </h5>
                <div class="ibox-tools">
                    @(Html.Bootstrap()
                        .ActionLink("Thêm công ty mới", "Create")
                        .Class("btn btn-primary btn-sm")
                        .PrependIcon("fa fa-plus"))

                    <button id="activate-selected" class="btn btn-success btn-sm m-l-sm" disabled><i class="fa fa-check"></i> Kích hoạt selected</button>
                    <button id="deactivate-selected" class="btn btn-danger btn-sm m-l-sm" disabled><i class="fa fa-ban"></i> Vô hiệu hóa selected</button>
                </div>
            </div>
            <div class="ibox-content p-sm">

                <div class="row">
                    <div class="col-md-8 m-b-sm">
                        @using (Html.BeginForm("Index", "Supplier", FormMethod.Get,
                                new { @class = "form-horizontal", role = "search", id = "searchSupplier" }))
                        {
                            <div class="input-group">
                                @Html.TextBox("keyword", ViewBag.Keyword as string, new
                                {
                                    placeholder = "Nhập tên công ty hoặc thông tin liên lạc khác",
                                    @class = "input-sm form-control"
                                })

                                @Html.DropDownList("actived", new SelectList(
                                    new[]
                                    {
                                        new { Value = "", Text = "Tất cả trạng thái" },
                                        new { Value = "1", Text = "Hoạt động" },
                                        new { Value = "0", Text = "Không hoạt động" }
                                    }, "Value", "Text", ViewBag.Actived), new { @class = "input-sm form-control m-l-sm", id = "activedFilter" })

                                <input type="hidden" name="pageSize" value="@ViewBag.CurrentPageSize" id="pagedSize" />

                                <span class="input-group-btn">
                                    <button type="submit" class="btn btn-sm btn-primary"><i class="fa fa-search"></i> Tìm kiếm</button>
                                    @(Html.ActionLink("Bỏ lọc", "Index", null,
                                            new { @class = "btn btn-sm btn-warning m-l-xs" }))
                                </span>
                            </div>
                        }
                    </div>
                    <div class="col-md-4 m-b-sm"></div>
                </div>

                <table id="tblsuppliers" class="table table-responsive table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="40px"><input type="checkbox" id="select-all"></th>
                            <th>Tên công ty</th>
                            <th width="20%" class="hidden-sm hidden-xs">Thông tin liên hệ</th>
                            <th width="30%" class="hidden-sm hidden-xs">Thông tin khác</th>
                            <th width="100px" class="text-center">Trạng thái</th>
                            <th width="120px">Chức năng</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><input type="checkbox" class="select-row" data-id="@item.SupplierId"></td>
                                <td>
                                    <strong>@Html.DisplayFor(modelItem => item.Name) </strong>
                                    <br />
                                    <small>@Html.DisplayFor(modelItem => item.Description)</small>
                                </td>

                                <td class="hidden-sm hidden-xs">
                                    <ul class="info-list">
                                        @if (!string.IsNullOrWhiteSpace(item.ContactName))
                                        {
                                            <li>
                                                <i class="fa fa-user"></i>
                                                @Html.DisplayFor(modelItem => item.ContactName)
                                            </li>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(item.ContactTitle))
                                        {
                                            <li>
                                                <i class="fa fa-id-badge"></i>
                                                @Html.DisplayFor(modelItem => item.ContactTitle)
                                            </li>
                                        }
                                    </ul>
                                </td>

                                <td class="hidden-sm hidden-xs">
                                    <ul class="info-list">
                                        @if (!string.IsNullOrWhiteSpace(item.Address))
                                        {
                                            <li>
                                                <i class="fa fa-map-marker"></i>
                                                @Html.DisplayFor(modelItem => item.Address)
                                            </li>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(item.Phone))
                                        {
                                            <li>
                                                <i class="fa fa-phone"></i>
                                                @Html.DisplayFor(modelItem => item.Phone)
                                            </li>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(item.Fax))
                                        {
                                            <li>
                                                <i class="fa fa-fax"></i>
                                                @Html.DisplayFor(modelItem => item.Fax)
                                            </li>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(item.Email))
                                        {
                                            <li>
                                                <i class="fa fa-envelope"></i>
                                                @Html.DisplayFor(modelItem => item.Email)
                                            </li>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(item.HomePage))
                                        {
                                            <li>
                                                <i class="fa fa-globe"></i>
                                                @Html.DisplayFor(modelItem => item.HomePage)
                                            </li>
                                        }
                                    </ul>
                                </td>

                                <td class="td_toggle text-center">
                                    <button type="button" class="toggle @(item.Actived.ToString().ToLower())"
                                            data-toggle-state="true"
                                            data-url="@Url.Action("UpdateToggle")"
                                            data-args="Actived_@(item.Actived.ToString().ToLower())_@(item.SupplierId)">
                                    </button>
                                </td>

                                <td class="text-center">
                                    @(Html.Bootstrap()
                                    .ActionLink("", "Details")
                                    .RouteValues(new { id = item.SupplierId })
                                    .Title("Xem chi tiết")
                                    .AppendIcon("fa fa-eye fa-lg m-r-xs"))
                                    @(Html.Bootstrap()
                                     .ActionLink("", "Edit")
                                     .RouteValues(new { id = item.SupplierId })
                                     .Title("Cập nhật")
                                     .AppendIcon("fa fa-pencil fa-lg m-r-xs"))

                                    @(Html.Bootstrap()
                                    .ActionLink("", "GetBySupplierId", "Product")
                                    .Class("ajax-link m-l-sm")
                                    .RouteValues(new { id = item.SupplierId })
                                    .Title("Xem danh sách sản phẩm")
                                    .AppendIcon("fa fa-gift fa-lg"))
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="row">
                    <div class="col-md-6 m-b-sm text-center">
                        Hiển thị
                        @(Html.DropDownList("pageSize", ViewBag.PageSize as SelectList,
                    new { @class = "input-sm", id = "pageSelect" }))
                        mẫu tin
                    </div>
                    <div class="col-md-6 m-b-sm text-center">
                        @(Html.PagedListPager(
                            Model,
                            page => Url.Action(
                                "Index",
                                new
                                {
                                    page,
                                    pageSize = ViewBag.CurrentPageSize,
                                    keyword = ViewBag.Keyword,
                                    actived = ViewBag.Actived
                                }),
                         PagedListRenderOptions.ClassicPlusFirstAndLast))
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script type="text/javascript">
        $(document).ready(function () {

            $('#activedFilter').change(function () {
                $('#searchSupplier').submit();
            });

            $('#pageSelect').change(function () {
                $('#pagedSize').val($(this).val());
                $('#searchSupplier').submit();
            });

            $('#select-all').change(function () {
                $('.select-row').prop('checked', this.checked);
                updateButtons();
            });

            $('#tblsuppliers').on('change', '.select-row', function () {
                updateButtons();
            });

            function updateButtons() {
                var count = $('.select-row:checked').length;
                $('#activate-selected').prop('disabled', count === 0);
                $('#deactivate-selected').prop('disabled', count === 0);
            }

            function toggleSelected(actived) {
                var ids = [];
                $('.select-row:checked').each(function () {
                    ids.push($(this).data('id'));
                });

                console.log("Sending IDs:", ids, "Actived:", actived); 

                if (ids.length === 0) {
                    alert("Chưa chọn nhà cung cấp nào.");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("ToggleMultiple", "Supplier")',
                    type: 'POST',
                    traditional: true,
                    data: { ids: ids, actived: actived },
                    success: function (response) {
                        console.log("Response:", response); 
                        if (response.success) {
                            alert(response.message || 'Thay đổi trạng thái thành công!');
                            location.reload();
                        } else {
                            alert('Lỗi từ server: ' + (response.message || 'Không rõ'));
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", xhr.responseText); 
                        alert('Lỗi kết nối server: ' + xhr.status + ' - ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                    }
                });
            }

            $('#activate-selected').click(function () {
                if (confirm('Bạn chắc chắn muốn KÍCH HOẠT các nhà cung cấp đã chọn?')) {
                    toggleSelected(true);
                }
            });

            $('#deactivate-selected').click(function () {
                if (confirm('Bạn chắc chắn muốn VÔ HIỆU HÓA các nhà cung cấp đã chọn?')) {
                    toggleSelected(false);
                }
            });
        });
    </script>
}