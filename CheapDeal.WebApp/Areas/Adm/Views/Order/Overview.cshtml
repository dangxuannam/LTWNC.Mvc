@{
    ViewBag.Title = "Thống kê doanh thu";
    Layout = "~/Areas/Adm/Views/Shared/_Layout.cshtml";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Thống kê doanh thu</h2>
        <ol class="breadcrumb">
            <li><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
            <li><a href="@Url.Action("Index", "Order")">Đơn hàng</a></li>
            <li class="active"><strong>Thống kê</strong></li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-content">
                    @using (Html.BeginForm("Overview", "Order", FormMethod.Get, new { @class = "form-horizontal" }))
                    {
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Chọn thời gian:</label>
                            <div class="col-sm-3">
                                <select name="year" class="form-control" onchange="this.form.submit()">
                                    @foreach (var y in (List<int>)ViewBag.Years)
                                    {
                                        <option value="@y" @(y == ViewBag.SelectedYear ? "selected" : "")>Năm @y</option>
                                    }
                                </select>
                            </div>
                            <div class="col-sm-3">
                                <select name="month" class="form-control" onchange="this.form.submit()">
                                    <option value="">Cả năm</option>
                                    @for (int m = 1; m <= 12; m++)
                                    {
                                        <option value="@m" @(ViewBag.SelectedMonth != null && m == ViewBag.SelectedMonth ? "selected" : "")>
                                            Tháng @m
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-sm-4">
                                <a href="@Url.Action("Overview")" class="btn btn-white">
                                    <i class="fa fa-refresh"></i> Làm mới
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h5 class="text-muted">Tổng doanh thu</h5>
                    <h1 class="no-margins text-navy">@ViewBag.TotalRevenue.ToString("N0")</h1>
                    <small>VNĐ</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h5 class="text-muted">Tổng đơn hàng</h5>
                    <h1 class="no-margins text-success">@ViewBag.TotalOrders</h1>
                    <small>Đơn thành công</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h5 class="text-muted">Giá trị TB/Đơn</h5>
                    <h1 class="no-margins text-warning">@ViewBag.AvgOrderValue.ToString("N0")</h1>
                    <small>VNĐ</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h5 class="text-muted">Sản phẩm đã bán</h5>
                    <h1 class="no-margins text-danger">@ViewBag.TotalProductsSold</h1>
                    <small>Sản phẩm</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Biểu đồ doanh thu @(ViewBag.SelectedMonth != null ? "theo ngày" : "theo tháng")</h5>
                </div>
                <div class="ibox-content">
                    <div>
                        <canvas id="revenueChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Top 10 sản phẩm bán chạy</h5>
                </div>
                <div class="ibox-content">
                    <div>
                        <canvas id="topProductsChart" height="200"></canvas>
                    </div>
                    <div class="m-t-md">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int index = 1;
                                        var topProducts = ViewBag.TopProducts as List<dynamic>;
                                    }
                                    @if (topProducts != null && topProducts.Any())
                                    {
                                        foreach (var product in topProducts)
                                        {
                                            <tr>
                                                <td>@index</td>
                                                <td>@product.ProductName</td>
                                                <td><strong class="text-navy">@product.Quantity</strong></td>
                                                <td><strong class="text-success">@((int)product.Revenue).ToString("N0") đ</strong></td>
                                            </tr>
                                            index++;
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">Chưa có dữ liệu</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Phân bổ đơn hàng theo trạng thái</h5>
                </div>
                <div class="ibox-content">
                    <div>
                        <canvas id="statusChart" height="200"></canvas>
                    </div>
                    <div class="m-t-md">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Trạng thái</th>
                                        <th>Số lượng</th>
                                        <th>Doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var ordersByStatus = ViewBag.OrdersByStatus as List<dynamic>;
                                    }
                                    @if (ordersByStatus != null && ordersByStatus.Any())
                                    {
                                        foreach (var status in ordersByStatus)
                                        {
                                            <tr>
                                                <td>
                                                    @switch ((CheapDeal.WebApp.Models.OrderStatus)status.Status)
                                                    {
                                                        case CheapDeal.WebApp.Models.OrderStatus.New:
                                                            <span class="label label-info">Mới</span>
                                                            break;
                                                        case CheapDeal.WebApp.Models.OrderStatus.Approved:
                                                            <span class="label label-primary">Đã xác nhận</span>
                                                            break;
                                                        case CheapDeal.WebApp.Models.OrderStatus.Shipping:
                                                            <span class="label label-warning">Đang giao</span>
                                                            break;
                                                        case CheapDeal.WebApp.Models.OrderStatus.Success:
                                                            <span class="label label-success">Thành công</span>
                                                            break;
                                                        case CheapDeal.WebApp.Models.OrderStatus.Cancelled:
                                                            <span class="label label-danger">Đã hủy</span>
                                                            break;
                                                        case CheapDeal.WebApp.Models.OrderStatus.Returned:
                                                            <span class="label label-default">Đã trả hàng</span>
                                                            break;
                                                    }
                                                </td>
                                                <td><strong>@status.Count</strong></td>
                                                <td><strong class="text-navy">@((decimal)status.Revenue).ToString("N0") đ</strong></td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">Chưa có dữ liệu</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        $(document).ready(function () {
            var revenueCtx = document.getElementById('revenueChart').getContext('2d');
            var revenueData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.RevenueByTime));
            var timeLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.TimeLabels));

            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: revenueData,
                        backgroundColor: 'rgba(26, 179, 148, 0.2)',
                        borderColor: 'rgba(26, 179, 148, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    }
                }
            });
           @{
            var topProductsList = ViewBag.TopProducts as List<dynamic>;
            var productNames = topProductsList?.Select(p => ((string)p.ProductName).Length > 30 ?
            ((string)p.ProductName).Substring(0, 27) + "..." :
            (string)p.ProductName).ToList() ?? new List<string>();
            var productQuantities = topProductsList?.Select(p => (int)p.Quantity).ToList() ?? new List<int>();
}

            var topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            var productNames = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(productNames));
            var productQuantities = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(productQuantities));

            new Chart(topProductsCtx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Số lượng bán',
                        data: productQuantities,
                        backgroundColor: [
                            'rgba(26, 179, 148, 0.8)',
                            'rgba(237, 85, 101, 0.8)',
                            'rgba(243, 156, 18, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(230, 126, 34, 0.8)',
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(149, 165, 166, 0.8)',
                            'rgba(52, 73, 94, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
           @{
               var ordersByStatusChart = ViewBag.OrdersByStatus as List<dynamic>;
               var statusLabels = new List<string>();
               var statusCounts = new List<int>();

               if (ordersByStatusChart != null)
               {
                   foreach (var item in ordersByStatusChart)
                   {
                       var status = (CheapDeal.WebApp.Models.OrderStatus)item.Status;
                       statusLabels.Add(status.ToString());
                       statusCounts.Add((int)item.Count);
                   }
               }
            }

            var statusCtx = document.getElementById('statusChart').getContext('2d');
            var statusLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(statusLabels));
            var statusCounts = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(statusCounts));

            var statusNames = {
                'New': 'Mới',
                'Approved': 'Đã xác nhận',
                'Shipping': 'Đang giao',
                'Success': 'Thành công',
                'Cancelled': 'Đã hủy',
                'Returned': 'Đã trả hàng'
            };

            var statusColors = {
                'New': 'rgba(91, 192, 222, 0.8)',
                'Approved': 'rgba(51, 122, 183, 0.8)',
                'Shipping': 'rgba(240, 173, 78, 0.8)',
                'Success': 'rgba(92, 184, 92, 0.8)',
                'Cancelled': 'rgba(217, 83, 79, 0.8)',
                'Returned': 'rgba(149, 165, 166, 0.8)'
            };

            var translatedLabels = statusLabels.map(function(label) {
                return statusNames[label] || label;
            });

            var backgroundColors = statusLabels.map(function(label) {
                return statusColors[label] || 'rgba(149, 165, 166, 0.8)';
            });

            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: translatedLabels,
                    datasets: [{
                        data: statusCounts,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
    </script>
}

<style>
    .ibox-content h1 {
        font-size: 32px;
        font-weight: 600;
    }

    .no-margins {
        margin: 0 !important;
    }
</style>

