@model CheapDeal.WebApp.Models.Order

@{
    ViewBag.Title = "Chỉnh sửa đơn hàng #" + Model.OrderId;
    Layout = "~/Areas/Adm/Views/Shared/_Layout.cshtml";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Chỉnh sửa đơn hàng #@Model.OrderId</h2>
        <ol class="breadcrumb">
            <li><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
            <li><a href="@Url.Action("Index", "Order")">Đơn hàng</a></li>
            <li class="active"><strong>Chỉnh sửa</strong></li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Thông tin đơn hàng</h5>
                </div>
                <div class="ibox-content">
                    @using (Html.BeginForm("Edit", "Order", FormMethod.Post, new { @class = "form-horizontal", id = "orderForm" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.OrderId)

                        if (TempData["Error"] != null)
                        {
                            <div class="alert alert-danger alert-dismissable">
                                <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                                <strong>Lỗi!</strong> @TempData["Error"]
                            </div>
                        }

                        if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger alert-dismissable">
                                <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                                <strong>Dữ liệu không hợp lệ:</strong>
                                <ul style="margin-bottom: 0;">
                                    @foreach (var modelState in ViewData.ModelState.Values)
                                    {
                                        foreach (var error in modelState.Errors)
                                        {
                                            <li>@error.ErrorMessage</li>
                                        }
                                    }
                                </ul>
                            </div>
                        }

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Người nhận <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                                @Html.TextBoxFor(m => m.ShipName, new { @class = "form-control", required = "required", placeholder = "Nhập tên người nhận" })
                                @Html.ValidationMessageFor(m => m.ShipName, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Số điện thoại <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                                @Html.TextBoxFor(m => m.ShipTel, new { @class = "form-control", required = "required", placeholder = "Nhập số điện thoại" })
                                @Html.ValidationMessageFor(m => m.ShipTel, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Địa chỉ giao hàng <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                                @Html.TextAreaFor(m => m.ShipAddress, new { @class = "form-control", rows = "3", required = "required", placeholder = "Nhập địa chỉ giao hàng" })
                                @Html.ValidationMessageFor(m => m.ShipAddress, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Ngày yêu cầu giao</label>
                            <div class="col-sm-10">
                                @Html.TextBoxFor(m => m.RequiredDate, new { @class = "form-control", type = "date", Value = Model.RequiredDate.HasValue ? Model.RequiredDate.Value.ToString("yyyy-MM-dd") : "" })
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Tuyến vận chuyển <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                                <select name="ShippingRateId" class="form-control" id="shippingRateSelect" required>
                                    <option value="">-- Chọn tuyến vận chuyển --</option>
                                </select>
                                <span class="help-block">Chọn tuyến vận chuyển phù hợp với khu vực và trọng lượng hàng hóa</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Phí vận chuyển</label>
                            <div class="col-sm-10">
                                @Html.TextBoxFor(m => m.Freight, new { @class = "form-control", type = "number", min = "0", step = "1000", id = "freightInput" })
                                <span class="help-block">Phí vận chuyển sẽ tự động cập nhật khi chọn tuyến</span>
                            </div>
                        </div>

                        @Html.HiddenFor(m => m.ShipVia, new { id = "shipViaInput" })

                        <div class="form-group">
                            <label class="col-sm-2 control-label">Ghi chú</label>
                            <div class="col-sm-10">
                                @Html.TextAreaFor(m => m.Notes, new { @class = "form-control", rows = "3", placeholder = "Nhập ghi chú cho đơn hàng (nếu có)" })
                            </div>
                        </div>

                        <div class="hr-line-dashed"></div>

                        <h3>Chi tiết đơn hàng <span class="text-danger">*</span></h3>

                        <div class="form-group">
                            <div class="col-sm-12">
                                <button type="button" class="btn btn-primary" id="addProduct">
                                    <i class="fa fa-plus"></i> Thêm sản phẩm
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="orderDetailsTable">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <th style="width: 40%;" class="text-center">Sản phẩm</th>
                                        <th style="width: 13%;" class="text-center">Giá</th>
                                        <th style="width: 12%;" class="text-center">Số lượng</th>
                                        <th style="width: 13%;" class="text-center">Giảm giá (%)</th>
                                        <th style="width: 15%;" class="text-center">Thành tiền</th>
                                        <th style="width: 7%;" class="text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="orderDetailsBody">
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-right"><strong>Tổng tiền hàng:</strong></td>
                                        <td colspan="2"><strong id="totalAmount">0 đ</strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-right"><strong>Phí vận chuyển:</strong></td>
                                        <td colspan="2"><strong id="shippingFee">0 đ</strong></td>
                                    </tr>
                                    <tr class="bg-info">
                                        <td colspan="4" class="text-right"><h4 style="margin: 0;"><strong>TỔNG CỘNG:</strong></h4></td>
                                        <td colspan="2"><h4 style="margin: 0;"><strong id="grandTotal" class="text-navy">0 đ</strong></h4></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="hr-line-dashed"></div>

                        <div class="form-group">
                            <div class="col-sm-12 text-center">
                                <a href="@Url.Action("Index")" class="btn btn-white btn-lg">
                                    <i class="fa fa-arrow-left"></i> Hủy
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="fa fa-save"></i> Cập nhật đơn hàng
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var rowIndex = 0;
        var products = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Products));
        var shippingRates = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.ShippingRates));

        var existingDetails = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
            Model.OrderDetails.Select(d => new {
                OrderId = d.OrderId,
                ProductId = d.ProductId,
                Price = d.Price,
                Quantity = d.Quantity,
                Discount = d.Discount * 100, 
                ProductName = d.Product != null ? d.Product.Name : ""
            })
        ));

        $(document).ready(function () {
            console.log('Products:', products);
            console.log('ShippingRates:', shippingRates);
            console.log('Existing Details:', existingDetails);

            if (shippingRates && shippingRates.length > 0) {
                shippingRates.forEach(function(rate) {
                    var selected = rate.ShipperId == @(Model.ShipVia ?? 0) ? 'selected' : '';
                    $('#shippingRateSelect').append(
                        `<option value="${rate.Id}" data-price="${rate.Price}" data-shipper="${rate.ShipperId}" ${selected}>
                            ${rate.DisplayText} - ${formatCurrency(rate.Price)}
                        </option>`
                    );
                });

                if (@(Model.ShipVia ?? 0) > 0) {
                    $('#shippingRateSelect').trigger('change');
                }
            }

            $('#shippingRateSelect').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var price = selectedOption.data('price') || 0;
                var shipperId = selectedOption.data('shipper') || 0;

                $('#freightInput').val(price);
                $('#shipViaInput').val(shipperId);

                updateTotals();
            });

            if (existingDetails && existingDetails.length > 0) {
                existingDetails.forEach(function(detail) {
                    addProductRow(detail);
                });
            } else {
                addProductRow();
            }

            $('#addProduct').on('click', function () {
                addProductRow();
            });
        });

        function addProductRow(existingDetail = null) {
            var productOptions = '<option value="">-- Chọn sản phẩm --</option>';
            products.forEach(function(product) {
                var selected = existingDetail && product.ProductId == existingDetail.ProductId ? 'selected' : '';
                productOptions += `<option value="${product.ProductId}"
                    data-price="${product.Price}"
                    data-discount="${product.Discount}"
                    data-quantity="${product.Quantity}" ${selected}>
                    ${product.Name} (Tồn: ${product.Quantity})
                </option>`;
            });

            var price = existingDetail ? existingDetail.Price : 0;
            var quantity = existingDetail ? existingDetail.Quantity : 1;
            var discount = existingDetail ? existingDetail.Discount : 0; 

            var row = `
                <tr class="product-row" data-index="${rowIndex}">
                    <td>
                        <select name="productIds" class="form-control product-select" data-index="${rowIndex}" required>
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="prices" class="form-control price-input" data-index="${rowIndex}" min="0" step="1000" value="${price}" readonly />
                    </td>
                    <td>
                        <input type="number" name="quantities" class="form-control quantity-input" data-index="${rowIndex}" min="1" value="${quantity}" required />
                    </td>
                    <td>
                        <input type="number" name="discounts" class="form-control discount-input" data-index="${rowIndex}" min="0" max="100" step="0.01" value="${discount}" />
                    </td>
                    <td class="item-total text-right"><strong>0 đ</strong></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm remove-row" title="Xóa">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $('#orderDetailsBody').append(row);

            $(`.product-select[data-index="${rowIndex}"]`).on('change', function () {
                var selectedOption = $(this).find('option:selected');
                var index = $(this).data('index');
                var price = selectedOption.data('price') || 0;
                var discount = selectedOption.data('discount') || 0;
                var maxQty = selectedOption.data('quantity') || 0;

                $(`.price-input[data-index="${index}"]`).val(price);
                $(`.discount-input[data-index="${index}"]`).val(discount);
                $(`.quantity-input[data-index="${index}"]`).attr('max', maxQty);

                calculateRowTotal(index);
            });

            $(`.quantity-input[data-index="${rowIndex}"], .discount-input[data-index="${rowIndex}"]`).on('input', function () {
                var index = $(this).data('index');
                calculateRowTotal(index);
            });

            $('.remove-row').off('click').on('click', function () {
                if ($('#orderDetailsBody tr').length > 1) {
                    $(this).closest('tr').remove();
                    updateTotals();
                } else {
                    alert('Phải có ít nhất một sản phẩm trong đơn hàng!');
                }
            });

            if (existingDetail) {
                calculateRowTotal(rowIndex);
            }

            rowIndex++;
        }

        function calculateRowTotal(index) {
            var price = parseFloat($(`.price-input[data-index="${index}"]`).val()) || 0;
            var quantity = parseInt($(`.quantity-input[data-index="${index}"]`).val()) || 0;
            var discount = parseFloat($(`.discount-input[data-index="${index}"]`).val()) || 0;

            var subtotal = price * quantity;
            var total = subtotal * (1 - discount / 100);

            $(`.product-row[data-index="${index}"] .item-total`).html('<strong>' + formatCurrency(total) + '</strong>');

            updateTotals();
        }

        function updateTotals() {
            var total = 0;
            $('.product-row').each(function () {
                var itemTotal = parseFloat($(this).find('.item-total').text().replace(/[^\d]/g, '')) || 0;
                total += itemTotal;
            });

            var freight = parseFloat($('#freightInput').val()) || 0;
            var grandTotal = total + freight;

            $('#totalAmount').text(formatCurrency(total));
            $('#shippingFee').text(formatCurrency(freight));
            $('#grandTotal').text(formatCurrency(grandTotal));
        }

        function formatCurrency(amount) {
            return Math.round(amount).toLocaleString('vi-VN') + ' đ';
        }

        $('#orderForm').on('submit', function (e) {
            var hasProducts = $('#orderDetailsBody tr').length > 0;
            if (!hasProducts) {
                e.preventDefault();
                alert('Vui lòng thêm ít nhất một sản phẩm vào đơn hàng!');
                return false;
            }

            var shippingRateId = $('#shippingRateSelect').val();
            var shipVia = $('#shipViaInput').val();

            if (!shippingRateId) {
                e.preventDefault();
                alert('Vui lòng chọn tuyến vận chuyển!');
                return false;
            }

            if (!shipVia) {
                e.preventDefault();
                alert('Lỗi: ShipVia không được set. Vui lòng chọn lại tuyến vận chuyển!');
                return false;
            }

            var allSelected = true;
            $('.product-select').each(function() {
                if (!$(this).val()) {
                    allSelected = false;
                    return false;
                }
            });

            if (!allSelected) {
                e.preventDefault();
                alert('Vui lòng chọn sản phẩm cho tất cả các dòng!');
                return false;
            }

            var isValid = true;
            $('.product-row').each(function () {
                var index = $(this).data('index');
                var selectedOption = $(`.product-select[data-index="${index}"] option:selected`);
                var maxQty = selectedOption.data('quantity') || 0;
                var qty = parseInt($(`.quantity-input[data-index="${index}"]`).val()) || 0;

                if (qty > maxQty) {
                    alert('Số lượng sản phẩm "' + selectedOption.text() + '" vượt quá tồn kho!');
                    isValid = false;
                    return false;
                }

                if (qty <= 0) {
                    alert('Số lượng phải lớn hơn 0!');
                    isValid = false;
                    return false;
                }
            });

            if (!isValid) {
                e.preventDefault();
                return false;
            }

            $('#submitBtn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang xử lý...');
        });
    </script>

    <style>

        #orderDetailsTable thead th {
            background-color: #1ab394 !important;
            color: white !important;
            font-weight: bold;
            padding: 12px 8px;
            vertical-align: middle;
        }

        #orderDetailsTable tbody td {
            vertical-align: middle;
            padding: 8px;
        }

        .remove-row {
            padding: 4px 8px;
        }
    </style>
}

