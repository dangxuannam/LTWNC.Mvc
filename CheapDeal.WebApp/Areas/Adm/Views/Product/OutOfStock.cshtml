@model PagedList.IPagedList<CheapDeal.WebApp.Models.Product>
@using PagedList.Mvc
@using CheapDeal.WebApp.Areas.Adm.Models

@{
    ViewBag.Title = "Sản phẩm hết hàng";
    var searchModel = ViewBag.SearchModel as ProductSearchModel;
}
<style>
    .btn-update-stock {
        margin-right: 5px;
    }

    #modal-quantity {
        font-size: 18px;
        text-align: center;
    }

    .modal-body .alert {
        margin-bottom: 20px;
    }
</style>
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>
            <i class="fa fa-exclamation-triangle text-danger"></i>
            Sản phẩm hết hàng
        </h2>
        <ol class="breadcrumb">
            <li>@Html.ActionLink("Trang chủ", "Index", "Dashboard")</li>
            <li>@Html.ActionLink("Sản phẩm", "Index", "Product")</li>
            <li class="active"><strong>Hết hàng</strong></li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    @Html.AntiForgeryToken()
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>
                        <i class="fa fa-warning text-danger"></i>
                        Danh sách sản phẩm hết hàng (@Model.TotalItemCount)
                    </h5>

                    <div class="ibox-tools">
                        @using (Html.BeginForm("OutOfStock", "Product", FormMethod.Get, new { @class = "form-inline" }))
                        {
                            <div class="input-group">
                                <input type="text" name="Keyword"
                                       value="@searchModel?.Keyword"
                                       class="form-control input-sm"
                                       placeholder="Tìm sản phẩm..." />
                                <span class="input-group-btn">
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fa fa-search"></i> Tìm
                                    </button>
                                </span>
                            </div>
                        }
                    </div>
                </div>

                <div class="ibox-content">
                    @if (Model.Count == 0)
                    {
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle"></i>
                            <strong>Tuyệt vời!</strong> Không có sản phẩm nào hết hàng.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle"></i>
                            Có <strong>@Model.TotalItemCount</strong> sản phẩm hết hàng. Vui lòng nhập thêm hàng!
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Hình ảnh</th>
                                        <th>Mã SP</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Nhà cung cấp</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-right">Giá bán</th>
                                        <th class="text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="product-table-body">
                                    @foreach (var item in Model)
                                    {
                                        <tr data-product-id="@item.ProductId">
                                            <td>
                                                <img src="@Url.Content(item.ThumbImage)"
                                                     alt="@item.Name"
                                                     style="width: 50px; height: 50px; object-fit: cover;"
                                                     onerror="this.src='/Content/Images/no-image.png'" />
                                            </td>
                                            <td>
                                                <strong class="text-danger">@item.ProductCode</strong>
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Edit", new { id = item.ProductId })">
                                                    @item.Name
                                                </a>
                                            </td>
                                            <td>@(item.Supplier?.Name ?? "N/A")</td>
                                            <td class="text-center">
                                                <span class="label label-danger">
                                                    <i class="fa fa-times"></i> @item.Quantity
                                                </span>
                                            </td>
                                            <td class="text-right">
                                                @String.Format("{0:N0}", item.Price) đ
                                            </td>
                                            <td class="text-center">
                                                <button type="button"
                                                        class="btn btn-sm btn-primary btn-update-stock"
                                                        data-product-id="@item.ProductId"
                                                        data-product-name="@item.Name">
                                                    <i class="fa fa-plus"></i> Nhập hàng
                                                </button>
                                                <a href="@Url.Action("Edit", new { id = item.ProductId })"
                                                   class="btn btn-sm btn-info">
                                                    <i class="fa fa-edit"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="text-center">
                            @Html.PagedListPager(Model, page => Url.Action("OutOfStock", new
                            {
                                PageIndex = page,
                                PageSize = searchModel?.PageSize,
                                Keyword = searchModel?.Keyword
                            }))
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateStockModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">
                    <i class="fa fa-plus-circle"></i> Nhập hàng nhanh
                </h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Sản phẩm:</strong> <span id="modal-product-name"></span>
                </div>
                <div class="form-group">
                    <label>Số lượng nhập: <span class="text-danger">*</span></label>
                    <input type="number"
                           id="modal-quantity"
                           class="form-control input-lg"
                           min="1"
                           max="10000"
                           value="10"
                           placeholder="Nhập số lượng..."
                           autofocus />
                    <span class="help-block">Nhập số lượng từ 1 đến 10,000</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">
                    <i class="fa fa-times"></i> Hủy
                </button>
                <button type="button" class="btn btn-primary" id="btn-confirm-update">
                    <i class="fa fa-check"></i> Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            var currentProductId = 0;

            $(document).on('click', '.btn-update-stock', function (e) {
                e.preventDefault();
                currentProductId = $(this).data('product-id');
                var productName = $(this).data('product-name');

                $('#modal-product-name').text(productName);
                $('#modal-quantity').val(10);
                $('#updateStockModal').modal('show');
            });
            $('#btn-confirm-update').on('click', function () {
                var newQuantity = parseInt($('#modal-quantity').val());

                if (isNaN(newQuantity) || newQuantity <= 0 || newQuantity > 10000) {
                    alert('Vui lòng nhập số lượng từ 1 đến 10,000!');
                    return;
                }

                var token = $('input[name="__RequestVerificationToken"]').val();
                if (!token) {
                    alert('Lỗi: Không tìm thấy token bảo mật. Tải lại trang!');
                    return;
                }

                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang xử lý...');

                $.ajax({
                    url: '@Url.Action("QuickUpdateStock", "Product")',
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: token,
                        productId: currentProductId,
                        newQuantity: newQuantity
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message || 'Đã cập nhật số lượng thành công!');  // ← Thông báo popup

                            $('#updateStockModal').modal('hide');

                            var $row = $('tr[data-product-id="' + currentProductId + '"]');
                            $row.fadeOut(500, function () {
                                $(this).remove();
                                if ($('table tbody tr').length === 0) {
                                    location.reload();
                                }
                            });
                        } else {
                            alert(response.message || 'Cập nhật thất bại!');
                        }
                    },
                    error: function (xhr) {
                            alert('Có lỗi xảy ra! Chi tiết: ' + (xhr.responseText || 'Không rõ'));
                    },
                    complete: function () {
                        $('#btn-confirm-update').prop('disabled', false).html('<i class="fa fa-check"></i> Xác nhận');
                    }
                });
            });
            $('#modal-quantity').on('keypress', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#btn-confirm-update').click();
                }
            });

            $('#updateStockModal').on('hidden.bs.modal', function () {
                $('#modal-quantity').val(10);
                currentProductId = 0;
            });
        });
    </script>
}